# How to Flatpak an OCaml application

Let's take a couple [OCaml](https://ocaml.org/) applications to illustrate [Flatpak](https://flatpak.org/) distributing and packaging leveraging the [Flatpak SDK Extension for OCaml](https://github.com/josecastillolema/org.freedesktop.Sdk.Extension.ocaml):
 - a hello world CLI application
 - a simple GTK program from the [Introduction to Gtk](https://v2.ocaml.org/learn/tutorials/introduction_to_gtk.html) OCaml tutorial

## Creating a hello world CLI application

Create a hello world `example.ml`:
```ocaml
let () = print_endline "hello world"
```

You can compile your code with the OCaml compiler `ocamlopt` (no need to do so at this point):
```
$ ocamlopt -o example example.ml
$ ./example
hello world
```

### Flatpak manifest

Some things to note in the following manifest:
 - The SDK extension pointing to the [Flatpak SDK Extension for OCaml](https://github.com/josecastillolema/org.freedesktop.Sdk.Extension.ocaml)
 - The build options setting the `PATH` and some OCaml related environment variables
 - Installing the application to `/app/bin`

```yaml
app-id: flatpak.ocaml.example
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.ocaml
command: example

build-options:
  append-path: /usr/lib/sdk/ocaml/bin:/usr/lib/sdk/ocaml/5.0.0/_opam/bin
  env:
    CAML_LD_LIBRARY_PATH: /usr/lib/sdk/ocaml/5.0.0/_opam/lib/stublibs:/usr/lib/sdk/ocaml/5.0.0/_opam/lib/ocaml/stublibs:/usr/lib/sdk/ocaml/5.0.0/_opam/lib/ocaml
    OCAML_TOPLEVEL_PATH: /usr/lib/sdk/ocaml/5.0.0/_opam/lib/toplevel
    OPAMROOT: /usr/lib/sdk/ocaml
    OPAMSWITCH: /usr/lib/sdk/ocaml/5.0.0
    OPAM_SWITCH_PREFIX: /usr/lib/sdk/ocaml/5.0.0/_opam

modules:
  - name: example
    buildsystem: simple
    sources:
      - type: file
        path: example.ml
    build-commands:
      - ocamlopt -o example example.ml
      - install -Dm755 example -t /app/bin/
```

### Install and run the application

Build and install the Flatpak package locally using `flatpak-builder`:
```
$ flatpak-builder --force-clean build-dir flatpak.ocaml.example.yaml
$ flatpak-builder --user --install --force-clean build-dir flatpak.ocaml.example.yaml
```

Run the application:
```
$ flatpak run flatpak.ocaml.example
hello world
```

Info on how to later publish the application on [Flathub](https://flathub.org/) can be found [here](https://docs.flathub.org/docs/for-app-authors/submission/).


## Creating a simple GTK program

Let's use the simple `lablgtk` program from the [Introduction to Gtk](https://v2.ocaml.org/learn/tutorials/introduction_to_gtk.html) OCaml tutorial `simple.ml`:
```ocaml
open GMain
open GdkKeysyms

let locale = GtkMain.Main.init ()

let main () =
  let window = GWindow.window ~width:320 ~height:240
                              ~title:"Simple lablgtk program" () in
  let vbox = GPack.vbox ~packing:window#add () in
  window#connect#destroy ~callback:Main.quit;

  (* Menu bar *)
  let menubar = GMenu.menu_bar ~packing:vbox#pack () in
  let factory = new GMenu.factory menubar in
  let accel_group = factory#accel_group in
  let file_menu = factory#add_submenu "File" in

  (* File menu *)
  let factory = new GMenu.factory file_menu ~accel_group in
  factory#add_item "Quit" ~key:_Q ~callback: Main.quit;

  (* Button *)
  let button = GButton.button ~label:"Push me!"
                              ~packing:vbox#add () in
  button#connect#clicked ~callback: (fun () -> prerr_endline "Ouch!");

  (* Display the windows and enter Gtk+ main loop *)
  window#add_accel_group accel_group;
  window#show ();
  Main.main ()

let () = main ()
```

You can install the dependencies and compile your code (no need to do so at this point):
```
$ opam install lablgtk
$ ocamlfind ocamlc -g -package lablgtk2 -linkpkg simple.ml -o simple
$ ./simple
Ouch!
```

This is what you should see when you run it:

![](img/simple.png)

### Preparations

We need to opam install `lablgtk` into the Flatpak. For that, let's leverage [flatpak-opam-generator](https://github.com/josecastillolema/flatpak-opam-generator), a helper tool to automatically generate flatpak-builder sources file from a `.json` generated by `opam tree`:
```
$ opam tree --json=lablgtk.json lablgtk
$ ./flatpak-opam-generator.py lablgtk.json > sources/lablgtk.json
```

The output sources file `sources/lablgtk.json` should look something like this:
```json
[
  {
    "type": "file",
    "url": "https://github.com/garrigue/lablgtk/archive/2.18.13.tar.gz",
    "name": "lablgtk.2.18.13",
    "md5": "d0a326b99475216cc22232e72c89415f",
    "dest": "cache/md5/d0",
    "dest-filename": "d0a326b99475216cc22232e72c89415f"
  },
  {
    "type": "file",
    "url": "https://github.com/ocaml/camlp-streams/archive/v5.0.1.tar.gz",
    "name": "camlp-streams.5.0.1",
    "md5": "afc874b25f7a1f13e8f5cfc1182b51a7",
    "dest": "cache/md5/af",
    "dest-filename": "afc874b25f7a1f13e8f5cfc1182b51a7"
  },
  {
    "type": "file",
    "url": "https://github.com/ocaml/dune/releases/download/3.10.0/dune-3.10.0.tbz",
    "name": "dune.3.10.0",
    "sha256": "9ff03384a98a8df79852cc674f0b4738ba8aec17029b6e2eeb514f895e710355",
    "dest": "cache/sha256/9f",
    "dest-filename": "9ff03384a98a8df79852cc674f0b4738ba8aec17029b6e2eeb514f895e710355"
  },
  {
    "type": "file",
    "url": "http://download.camlcity.org/download/findlib-1.9.6.tar.gz",
    "name": "ocamlfind.1.9.6",
    "md5": "96c6ee50a32cca9ca277321262dbec57",
    "dest": "cache/md5/96",
    "dest-filename": "96c6ee50a32cca9ca277321262dbec57"
  }
]
```

Let's use the helper tool to generate the corresponding Flatpak manifest code:
```yaml
$ ./flatpak-opam-generator.py --generate lablgtk lablgtk.json
...
# Generated manifest code by flatpak-opam-generator
- name: lablgtk
  buildsystem: simple
  build-options:
    append-path: /usr/lib/sdk/ocaml/bin
    env:
      OPAMROOT: /usr/lib/sdk/ocaml
      OPAMSWITCH: /usr/lib/sdk/ocaml/5.0.0
  sources:
    - sources/lablgtk.json
    - type: git
      branch: master
      url: https://github.com/ocaml/opam-repository
  build-commands:
    - ls -A --color=never | grep -Ev "cache|packages|repo" | xargs rm -rf
    - opam admin filter -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6 
    - opam admin cache
    - opam repo add lablgtk .
    - opam install -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6 
    - opam repo remove --all lablgtk
  post-install:
    - opam info --field name,all-installed-versions lablgtk
```

We need the GTK2 library, let's grab it from [Flathub shared-modules repo](https://github.com/flathub/shared-modules):
```
$ git submodule add https://github.com/flathub/shared-modules.git
```

`LD_LIBRARY_PATH` is empty by default when running Flatpak applications ([flatpak/flatpak-builder#474](https://github.com/flatpak/flatpak-builder/issues/474)) so we will need a wrapper script `simple.sh` around the application:
```sh
export LD_LIBRARY_PATH=/app/lib
exec /app/bin/simple
```

### Flatpak manifest

Some things to note in the following manifest:
 - The SDK extension pointing to the [Flatpak SDK Extension for OCaml](https://github.com/josecastillolema/org.freedesktop.Sdk.Extension.ocaml)
 - The `writable-sdk` option uses a writable copy of the SDK for `/usr`. It is far from ideal but needed until a better approach comes up, as without it the build will fail:
    ```
    Fatal error:
    /usr/lib/sdk/ocaml/bin/opam: "open" failed on /usr/lib/sdk/ocaml/repo/lock: Read-only file system
    ```
    The less intrusive `ensure-writable` option does not seem to work in this scenario.
 - Permissions for the Flatpak app to access X11 (`--share=ipc` and `--socket=fallback-x11`)
 - The build options setting the `PATH` and some OCaml related environment variables
 - We are importing GTK2 from the shared modules repository
 - Installing the application to `/app/bin` and `lablgtk` library to `/app/lib`


```yaml
app-id: flatpak.ocaml.lablgtk
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.ocaml
writable-sdk: true
command: simple.sh
finish-args:
  - --share=ipc
  - --socket=fallback-x11

build-options:
  append-path: /usr/lib/sdk/ocaml/bin:/usr/lib/sdk/ocaml/5.0.0/_opam/bin
  env:
    CAML_LD_LIBRARY_PATH: /usr/lib/sdk/ocaml/5.0.0/_opam/lib/stublibs:/usr/lib/sdk/ocaml/5.0.0/_opam/lib/ocaml/stublibs:/usr/lib/sdk/ocaml/5.0.0/_opam/lib/ocaml
    OCAML_TOPLEVEL_PATH: /usr/lib/sdk/ocaml/5.0.0/_opam/lib/toplevel
    OPAMROOT: /usr/lib/sdk/ocaml
    OPAMSWITCH: /usr/lib/sdk/ocaml/5.0.0
    OPAM_SWITCH_PREFIX: /usr/lib/sdk/ocaml/5.0.0/_opam
    OPAMLOGS: /tmp

modules:

  - shared-modules/gtk2/gtk2.json

  - name: lablgtk
    buildsystem: simple
    sources:
      - sources/lablgtk.json
      - type: git
        branch: master
        url: https://github.com/ocaml/opam-repository
    build-commands:
      - ls -A --color=never | grep -Ev "cache|packages|repo" | xargs rm -rf
      - opam admin filter -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6 
      - opam admin cache
      - opam repo add lablgtk .
      - opam install -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6 
      - opam repo remove --all lablgtk
    post-install:
      - opam info --field name,all-installed-versions lablgtk

  - name: simple
    buildsystem: simple
    sources:
      - type: file
        path: simple.ml
    build-commands:
      - ocamlfind ocamlc -g -package lablgtk2 -linkpkg simple.ml -o simple
      - install -Dm755 simple -t /app/bin/
      - cp /usr/lib/sdk/ocaml/5.0.0/_opam/lib/stublibs/dlllablgtk2.so /app/lib

  - name: simple-wrapper
    buildsystem: simple
    sources:
      - type: file
        path: simple.sh
    build-commands:
      - cp simple.sh /app/bin
```

### Install and run the application

Build and install the Flatpak package locally using `flatpak-builder`:
```
$ flatpak-builder --force-clean build-dir flatpak.ocaml.lablgtk.yaml
$ flatpak-builder --user --install --force-clean build-dir flatpak.ocaml.lablgtk.yaml
```

Run the application:
```
$ flatpak run flatpak.ocaml.lablgtk
Ouch!
```

This is what you should see when you run it:

![](img/simple.png)

Info on how to later publish the application on [Flathub](https://flathub.org/) can be found [here](https://docs.flathub.org/docs/for-app-authors/submission/).
