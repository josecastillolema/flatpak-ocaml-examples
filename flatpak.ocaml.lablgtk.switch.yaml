# flatpak-builder --force-clean build-dir flatpak.ocaml.lablgtk.switch.yaml
# flatpak-builder --user --install --force-clean build-dir flatpak.ocaml.lablgtk.switch.yaml
# flatpak run flatpak.ocaml.lablgtk.switch

app-id: flatpak.ocaml.lablgtk.switch
runtime: org.freedesktop.Sdk
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.ocaml
command: simple.sh
finish-args:
  - --share=ipc
  - --socket=fallback-x11
build-options:
  append-path: /app/share/runtime/ocaml/bin:/app/share/runtime/ocaml/switch/_opam/bin:/usr/lib/sdk/ocaml/bin
  env:
    CAML_LD_LIBRARY_PATH: /app/share/runtime/ocaml/switch/_opam/lib/stublibs:/app/share/runtime/ocaml/switch/_opam/lib/ocaml/stublibs:/app/share/runtime/ocaml/switch/_opam/lib/ocaml
    OCAML_TOPLEVEL_PATH: /app/share/runtime/ocaml/switch/_opam/lib/toplevel
    OPAMROOT: /app/share/runtime/ocaml
    OPAMSWITCH: /app/share/runtime/ocaml/switch
    OPAM_SWITCH_PREFIX: /app/share/runtime/ocaml/switch/_opam

modules:
  - shared-modules/gtk2/gtk2.json

  - name: switch
    buildsystem: simple
    sources:
      - type: git
        branch: master
        url: https://github.com/ocaml/opam-repository
      - type: archive
        url: https://github.com/ocaml/ocaml/archive/refs/tags/5.1.0.tar.gz
        dest: switch
        sha256: 43a3ac7aab7f8880f2bb6221317be55319b356e517622fdc28359fe943e6a450
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/runtime/ocaml
      - mv switch ${FLATPAK_DEST}/share/runtime/ocaml
      - opam init -y --bare --disable-sandboxing .
      - opam switch create -y --deps-only ${FLATPAK_DEST}/share/runtime/ocaml/switch
      - opam pin -y ${FLATPAK_DEST}/share/runtime/ocaml/switch
    post-install:
      - opam switch list

  # Manifest code generated by flatpak-opam-generator
  - name: lablgtk
    buildsystem: simple
    sources:
      - sources/lablgtk.json
      - type: git
        branch: master
        url: https://github.com/ocaml/opam-repository
    build-commands:
      - ls -A --color=never | grep -Ev "cache|packages|repo" | xargs rm -rf
      - opam admin filter -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6
      - opam admin cache
      - opam repo add lablgtk .
      - opam install -y lablgtk.2.18.13 camlp-streams.5.0.1 dune.3.10.0 ocamlfind.1.9.6
      - opam repo remove --all lablgtk
    post-install:
      - opam info --field name,all-installed-versions lablgtk

  - name: simple
    buildsystem: simple
    sources:
      - type: file
        path: simple.ml
    build-commands:
      - ocamlfind ocamlopt -package lablgtk2 -linkpkg simple.ml -o simple
      - install -Dm755 simple -t /app/bin/
      - cp /app/share/runtime/ocaml/switch/_opam/lib/stublibs/dlllablgtk2.so /app/lib
    post-install:
      - rm -rf /app/share/runtime/ocaml

  - name: simple-wrapper
    buildsystem: simple
    sources:
      - type: file
        path: simple.sh
    build-commands:
      - cp simple.sh /app/bin
